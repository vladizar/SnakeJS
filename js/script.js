const e=document.querySelector(".game-screen"),t=document.querySelector(".menu-screen"),r=document.querySelector(".death-screen"),n=document.querySelector(".pause-screen");let s,l,a=[],o=[],i=[],u={},c="",y=0,d=0,m=0,p=[{x:0,y:0},{x:0,y:0}];const g=e.querySelector(".game-screen__field"),S=e.querySelector(".game-screen__score"),f=r.querySelector(".death-screen__score"),w=n.querySelector(".pause-screen__wrapper"),b=n.querySelector(".pause-screen__countdown"),k=b.querySelectorAll(".countdown__number"),h=n.querySelector(".pause-screen__score"),v=n.querySelector(".pause-screen__score_highest");function x(e,t,r,n){const s=document.createElement("div");for(const t of e)s.classList.add(t);s.style.gridColumnStart=t,s.style.gridRowStart=r,n.push(s),g.append(s)}function C(e,t){g.removeChild(e[t]),e.splice(t,1)}function R(e,t){return!(e>u.gameFieldSize||t>u.gameFieldSize||e<1||t<1)}function N(e,t,r,n=[-1]){for(const s of r)for(let r=0;r<s.length;r++){const l=s[r];if(l.style.gridColumnStart==e&&l.style.gridRowStart==t){if(n[r]==r)continue;return r}}return!1}function q(e){return Math.floor(Math.random().toFixed(8)*(e+1))}function A(){return Math.random().toFixed(2)}function _(){let e,t={x:0,y:0},r=0;do{++r>100&&M(),t.x=q(u.gameFieldSize),t.y=q(u.gameFieldSize),e=N(t.x,t.y,[a,o,i])}while(e||0===e||!R(t.x,t.y));return t}function F(){if(a.length<u.maxFruitsNumber){let e=_();fruitClass=A()<=.05?"grapes":A()<=.1?"strawberry":A()<=.2?"banana":a.length==u.minFruitsNumber-1?"apple-red":"apple-yellow",x(["fruit",fruitClass],e.x,e.y,a)}}function I(){switch(position=_(),u.direction){case"ArrowRight":position.y==o[0].style.gridRowStart&&position.x>o[0].style.gridColumnStart-u.snakeLength&&position.x<Number(o[0].style.gridColumnStart)+3*u.speed&&(position.y+=1);break;case"ArrowLeft":position.y==o[0].style.gridRowStart&&position.x<o[0].style.gridColumnStart-u.snakeLength&&position.x>Number(o[0].style.gridColumnStart)-3*u.speed&&(position.y+=1);break;case"ArrowUp":position.x==o[0].style.gridColumnStart&&position.y<o[0].style.gridRowStart-u.snakeLength&&position.y>Number(o[0].style.gridRowStart)-3*u.speed&&(position.x+=1);break;case"ArrowDown":position.x==o[0].style.gridColumnStart&&position.y>o[0].style.gridRowStart-u.snakeLength&&position.y<Number(o[0].style.gridRowStart)+3*u.speed&&(position.x+=1)}x(["water"],position.x,position.y,i)}function L(e){if(s)switch(e){case"ArrowRight":c=Number(o[0].style.gridColumnStart)+1==o[1].style.gridColumnStart?c:e;break;case"ArrowLeft":c=Number(o[0].style.gridColumnStart)-1==o[1].style.gridColumnStart?c:e;break;case"ArrowUp":c=Number(o[0].style.gridRowStart)-1==o[1].style.gridRowStart?c:e;break;case"ArrowDown":c=Number(o[0].style.gridRowStart)+1==o[1].style.gridRowStart?c:e}}function z(p=0){e.style.display="",setTimeout(()=>{t.style.display=r.style.display=n.style.display="none",s=setInterval(Y,1e3/m)},p),g.style.gridTemplateRows=g.style.gridTemplateColumns="repeat("+u.gameFieldSize+", 1fr)",g.style.gridGap=u.snakeView,g.innerHTML="",m=u.speed,c=u.direction,y=d=S.textContent=0,o=[],a=[],i=[],function(e,t){let r=snakePosY=Math.floor(u.gameFieldSize/2);x(["snake-block","snake-block_head"],r,snakePosY,o);for(let n=1;n<e;n++)switch(t){case"ArrowRight":x(["snake-block"],r-n,snakePosY,o);break;case"ArrowLeft":x(["snake-block"],r+n,snakePosY,o);break;case"ArrowUp":x(["snake-block"],r,snakePosY+n,o);break;case"ArrowDown":x(["snake-block"],r,snakePosY-n,o)}}(u.snakeLength,c);for(let e=0;e<u.minFruitsNumber;e++)F();for(;i.length<u.waterAreaSize;)I();l=setInterval(F,1e3*u.fruitsSpawnInterval)}function M(){clearInterval(s),clearInterval(l),s=!1,f.textContent=d,t.style.display=n.style.display="none",r.style.display=e.style.display=""}function T(){s&&(clearInterval(s),clearInterval(l),h.textContent=y,v.textContent=d,t.style.display=r.style.display=b.style.display="none",n.style.display=w.style.display=e.style.display="")}function D(e){m+e>u.speed&&(m+=e,clearInterval(s),s=setInterval(Y,1e3/m))}function Y(){!function(){for(let n=o.length-1;n>0;n--)e=o[n],t=o[n-1].style.gridColumnStart,r=o[n-1].style.gridRowStart,e.style.gridColumnStart=t,e.style.gridRowStart=r;var e,t,r;switch(c){case"ArrowRight":R(Number(o[0].style.gridColumnStart)+1,1)?o[0].style.gridColumnStart++:u.gameFieldInfinity?o[0].style.gridColumnStart=1:M();break;case"ArrowLeft":R(Number(o[0].style.gridColumnStart)-1,1)?o[0].style.gridColumnStart--:u.gameFieldInfinity?o[0].style.gridColumnStart=u.gameFieldSize:M();break;case"ArrowUp":R(1,Number(o[0].style.gridRowStart)-1)?o[0].style.gridRowStart--:u.gameFieldInfinity?o[0].style.gridRowStart=u.gameFieldSize:M();break;case"ArrowDown":R(1,Number(o[0].style.gridRowStart)+1)?o[0].style.gridRowStart++:u.gameFieldInfinity?o[0].style.gridRowStart=1:M()}}();let e=N(o[0].style.gridColumnStart,o[0].style.gridRowStart,[o],[0,1,2,3]);if(e)if(u.snakeSelfDestruct)for(let t=o.length-1;t>=e;t--){let e=1e3/m*(o.length-1-t)/8;setTimeout(()=>{o[t].classList.add("snake-block_damaged"),setTimeout(()=>{C(o,t),y&&(D(-u.speedMultiplier),S.textContent=--y)},e/1.5)},e)}else M();let t=N(o[0].style.gridColumnStart,o[0].style.gridRowStart,[a]);(t||0===t)&&(!function(e){switch(e){case"apple-yellow":y++;break;case"apple-red":y+=2;break;case"banana":y+=3;break;case"strawberry":y+=5;break;case"grapes":y+=10}y>d&&(d=y)}(a[t].classList[1]),D((y-S.textContent)*u.speedMultiplier),S.textContent=y,C(a,t),x(["snake-block"],o[o.length-1].style.gridColumnStart,o[o.length-1].style.gridRowStart,o),a.length<u.minFruitsNumber&&F());let r=N(o[0].style.gridColumnStart,o[0].style.gridRowStart,[i]);(r||0===r)&&(C(i,r),y-5>-1?(C(o,o.length-1),D(5*-u.speedMultiplier),y-=5,S.textContent=y):M())}document.addEventListener("touchstart",(function(e){p[0].x=e.changedTouches[0].pageX,p[0].y=e.changedTouches[0].pageY}),!1),document.addEventListener("touchend",(function(e){if(p[1].x=e.changedTouches[0].pageX,p[1].y=e.changedTouches[0].pageY,Math.abs(p[0].x-p[1].x)>Math.abs(p[0].y-p[1].y)&&Math.abs(p[0].x-p[1].x)>30){L(p[0].x>p[1].x?"ArrowLeft":"ArrowRight")}else if(Math.abs(p[0].y-p[1].y)>30){L(p[0].y>p[1].y?"ArrowUp":"ArrowDown")}else T()}),!1),window.onkeydown=function(e){L(e.key)};const P=t.querySelector(".game-settings-form"),U=P.querySelector("input[name=snake-start-length]"),E=P.querySelector("select[name=snake-start-direction]"),B=P.querySelector("input[name=snake-start-speed]"),V=P.querySelector("input[name=snake-speed-multiplier]"),X=P.querySelector("select[name=snake-body-view]"),G=P.querySelector("input[name=game-field-size]"),H=P.querySelector("select[name=game-field-infinity]"),W=P.querySelector("input[name=game-max-fruits]"),j=P.querySelector("input[name=game-min-fruits]"),J=P.querySelector("input[name=fruits-spawn-delay]"),K=P.querySelector("select[name=snake-self-destruct]"),O=P.querySelector("input[name=water-area-size]"),Q=document.querySelectorAll(".button_play"),Z=document.querySelectorAll(".button_menu"),$=document.querySelector(".button_continue");P.onsubmit=function(e){e.preventDefault(),u={snakeLength:Number(U.value),direction:E.value,speed:Number(B.value),speedMultiplier:Number(V.value),gameFieldSize:Number(G.value),gameFieldInfinity:Boolean(Number(H.value)),maxFruitsNumber:Number(W.value),minFruitsNumber:Number(j.value),fruitsSpawnInterval:Number(J.value),snakeView:X.value,snakeSelfDestruct:Boolean(Number(K.value)),waterAreaSize:Number(O.value)/100*Number(G.value)**2},z(400)};for(const e of Q)e.onclick=function(){z()};Q[0].onclick=()=>{this.offsetWidth};for(const a of Z)a.onclick=function(){clearInterval(s),clearInterval(l),s=!1,setTimeout(()=>{e.style.display=n.style.display=r.style.display="none"},400),t.classList.add("menu-screen_animated"),t.style.display=""};$.onclick=function(){!function(){w.style.display="none",b.style.display="";let e=0;k[e].style.display="";let a=setInterval(()=>{e++,k[e-1].style.display="none",k[e].style.display=""},1100);setTimeout(()=>{clearInterval(a),t.style.display=n.style.display=b.style.display=r.style.display="none",s=setInterval(Y,1e3/m),l=setInterval(F,1e3*u.fruitsSpawnInterval)},3300)}()},e.onclick=function(){T()},window.onkeyup=function(e){" "==e.key&&T()};