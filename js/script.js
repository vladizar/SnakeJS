const e=document.querySelector(".game-screen"),t=document.querySelector(".menu-screen"),r=document.querySelector(".death-screen"),a=r.querySelector(".button_play"),n=r.querySelector(".button_menu");let l,s,i=[],o=[],u={},c="",d=0,m=0,y=[{x:0,y:0},{x:0,y:0}];const g=e.querySelector(".game-screen__field"),S=e.querySelector(".game-screen__score"),f=r.querySelector(".death-screen__score");function p(e,t,r,a){const n=document.createElement("div");for(const t of e)n.classList.add(t);n.style.gridColumnStart=t,n.style.gridRowStart=r,a.push(n),g.append(n)}function w(e,t){g.removeChild(e[t]),e.splice(t,1)}function b(e,t){return!(e>u.gameFieldSize||t>u.gameFieldSize||e<1||t<1)}function k(e,t,r,a=[-1]){for(const n of r)for(let r=0;r<n.length;r++){const l=n[r];if(l.style.gridColumnStart==e&&l.style.gridRowStart==t){if(a[r]==r)continue;return r}}return!1}function h(e){return Math.floor(Math.random().toFixed(8)*(e+1))}function v(){return Math.random().toFixed(2)}function C(){if(i.length<u.maxFruitsNumber){let e;do{e={x:h(u.gameFieldSize),y:h(u.gameFieldSize)}}while(k(e.x,e.y,[i,o])||!b(e.x,e.y));fruitClass=v()<=.05?"grapes":v()<=.1?"strawberry":v()<=.2?"banana":i.length?"apple-yellow":"apple-red",p(["fruit",fruitClass],e.x,e.y,i)}}function x(e){switch(e){case"ArrowRight":c=Number(o[0].style.gridColumnStart)+1==o[1].style.gridColumnStart?c:e;break;case"ArrowLeft":c=Number(o[0].style.gridColumnStart)-1==o[1].style.gridColumnStart?c:e;break;case"ArrowUp":c=Number(o[0].style.gridRowStart)-1==o[1].style.gridRowStart?c:e;break;case"ArrowDown":c=Number(o[0].style.gridRowStart)+1==o[1].style.gridRowStart?c:e}}function N(a=0){e.style.display="",setTimeout(()=>{t.style.display=r.style.display="none",l=setInterval(q,1e3/m)},a),g.style.gridTemplateRows=g.style.gridTemplateColumns="repeat("+u.gameFieldSize+", 1fr)",g.style.gridGap=u.snakeView,g.innerHTML="",m=u.speed,c=u.direction,d=S.textContent=0,o=[],i=[],function(e,t){let r=snakePosY=Math.floor(u.gameFieldSize/2);p(["snake-block","snake-block_head"],r,snakePosY,o);for(let a=1;a<e;a++)switch(t){case"ArrowRight":p(["snake-block"],r-a,snakePosY,o);break;case"ArrowLeft":p(["snake-block"],r+a,snakePosY,o);break;case"ArrowUp":p(["snake-block"],r,snakePosY+a,o);break;case"ArrowDown":p(["snake-block"],r,snakePosY-a,o)}}(u.snakeLength,c);for(let e=0;e<u.minFruitsNumber;e++)C();s=setInterval(C,1e3*u.fruitsSpawnInterval)}function R(){clearInterval(l),clearInterval(s),f.textContent=d,t.style.display="none",r.style.display=e.style.display=""}function F(e){m+e>u.speed&&(m+=e,clearInterval(l),l=setInterval(q,1e3/m))}function q(){!function(){for(let a=o.length-1;a>0;a--)e=o[a],t=o[a-1].style.gridColumnStart,r=o[a-1].style.gridRowStart,e.style.gridColumnStart=t,e.style.gridRowStart=r;var e,t,r;switch(c){case"ArrowRight":b(Number(o[0].style.gridColumnStart)+1,1)?o[0].style.gridColumnStart++:u.gameFieldInfinity?o[0].style.gridColumnStart=1:R();break;case"ArrowLeft":b(Number(o[0].style.gridColumnStart)-1,1)?o[0].style.gridColumnStart--:u.gameFieldInfinity?o[0].style.gridColumnStart=u.gameFieldSize:R();break;case"ArrowUp":b(1,Number(o[0].style.gridRowStart)-1)?o[0].style.gridRowStart--:u.gameFieldInfinity?o[0].style.gridRowStart=u.gameFieldSize:R();break;case"ArrowDown":b(1,Number(o[0].style.gridRowStart)+1)?o[0].style.gridRowStart++:u.gameFieldInfinity?o[0].style.gridRowStart=1:R()}}();let e=k(o[0].style.gridColumnStart,o[0].style.gridRowStart,[o],[0,1,2,3]);if(e)if(u.snakeSelfDestruct)for(let t=o.length-1;t>=e;t--){let e=1e3/m*(o.length-1-t)/8;setTimeout(()=>{o[t].classList.add("snake-block_damaged"),setTimeout(()=>{w(o,t),d&&(F(-u.speedMultiplier),S.textContent=--d)},e/1.5)},e)}else R();let t=k(o[0].style.gridColumnStart,o[0].style.gridRowStart,[i]);(t||0===t)&&(!function(e){switch(e){case"apple-yellow":d++;break;case"apple-red":d+=2;break;case"banana":d+=3;break;case"strawberry":d+=5;break;case"grapes":d+=10}}(i[t].classList[1]),F((d-S.textContent)*u.speedMultiplier),S.textContent=d,w(i,t),p(["snake-block"],o[o.length-1].style.gridColumnStart,o[o.length-1].style.gridRowStart,o),i.length<u.minFruitsNumber&&C())}document.addEventListener("touchstart",(function(e){y[0].x=e.changedTouches[0].pageX,y[0].y=e.changedTouches[0].pageY}),!1),document.addEventListener("touchend",(function(e){if(y[1].x=e.changedTouches[0].pageX,y[1].y=e.changedTouches[0].pageY,Math.abs(y[0].x-y[1].x)>Math.abs(y[0].y-y[1].y)&&Math.abs(y[0].x-y[1].x)>30){x(y[0].x>y[1].x?"ArrowLeft":"ArrowRight")}else if(Math.abs(y[0].y-y[1].y)>30){x(y[0].y>y[1].y?"ArrowUp":"ArrowDown")}}),!1),window.onkeydown=function(e){x(e.key)};const A=t.querySelector(".game-settings-form"),I=A.querySelector("input[name=snake-start-length]"),L=A.querySelector("select[name=snake-start-direction]"),M=A.querySelector("input[name=snake-start-speed]"),T=A.querySelector("input[name=snake-speed-multiplier]"),_=A.querySelector("select[name=snake-body-view]"),z=A.querySelector("input[name=game-field-size]"),Y=A.querySelector("select[name=game-field-infinity]"),D=A.querySelector("input[name=game-max-fruits]"),P=A.querySelector("input[name=game-min-fruits]"),U=A.querySelector("input[name=fruits-spawn-delay]"),E=A.querySelector("select[name=snake-self-destruct]");A.onsubmit=function(e){e.preventDefault(),u={snakeLength:Number(I.value),direction:L.value,speed:Number(M.value),speedMultiplier:Number(T.value),gameFieldSize:Number(z.value),gameFieldInfinity:Boolean(Number(Y.value)),maxFruitsNumber:Number(D.value),minFruitsNumber:Number(P.value),fruitsSpawnInterval:Number(U.value),snakeView:_.value,snakeSelfDestruct:Boolean(Number(E.value))},N(400)},n.onclick=function(){setTimeout(()=>{e.style.display=r.style.display="none"},400),t.classList.add("menu-screen_animated"),t.style.display=""},a.onclick=function(){N()};