const e=document.querySelector(".game-screen"),t=document.querySelector(".menu-screen"),r=document.querySelector(".death-screen"),n=document.querySelector(".pause-screen");let l,a,s=[],o=[],i=[],u={},c="",y=0,d=0,m=0,g=[{x:0,y:0},{x:0,y:0}];const S=e.querySelector(".game-screen__field"),p=e.querySelector(".game-screen__score"),f=r.querySelector(".death-screen__score"),w=n.querySelector(".pause-screen__wrapper"),b=n.querySelector(".pause-screen__countdown"),k=b.querySelectorAll(".countdown__number"),h=n.querySelector(".pause-screen__score"),v=n.querySelector(".pause-screen__score_highest");function x(e,t,r,n){const l=document.createElement("div");for(const t of e)l.classList.add(t);l.style.gridColumnStart=t,l.style.gridRowStart=r,n.push(l),S.append(l)}function C(e,t){S.removeChild(e[t]),e.splice(t,1)}function R(e,t){return!(e>u.gameFieldSize||t>u.gameFieldSize||e<1||t<1)}function N(e,t,r,n=[-1]){for(const l of r)for(let r=0;r<l.length;r++){const a=l[r];if(a.style.gridColumnStart==e&&a.style.gridRowStart==t){if(n[r]==r)continue;return r}}return!1}function q(e){return Math.floor(Math.random().toFixed(8)*(e+1))}function A(){return Math.random().toFixed(2)}function _(){let e,t={x:0,y:0},r=0;do{++r>100&&M(),t.x=q(u.gameFieldSize),t.y=q(u.gameFieldSize),e=N(t.x,t.y,[s,o,i])}while(e||0===e||!R(t.x,t.y));return t}function F(){if(s.length<u.maxFruitsNumber){let e=_();fruitClass=A()<=.05?"grapes":A()<=.1?"strawberry":A()<=.2?"banana":s.length==u.minFruitsNumber-1?"apple-red":"apple-yellow",x(["fruit",fruitClass],e.x,e.y,s)}}function I(){const e=3*u.speed;let t=_();switch(u.direction){case"ArrowRight":t.y==o[0].style.gridRowStart&&t.x>o[0].style.gridColumnStart-u.snakeLength&&t.x<Number(o[0].style.gridColumnStart)+e&&(t.y+=1);break;case"ArrowLeft":t.y==o[0].style.gridRowStart&&t.x<o[0].style.gridColumnStart-u.snakeLength&&t.x>Number(o[0].style.gridColumnStart)-e&&(t.y+=1);break;case"ArrowUp":t.x==o[0].style.gridColumnStart&&t.y<o[0].style.gridRowStart-u.snakeLength&&t.y>Number(o[0].style.gridRowStart)-e&&(t.x+=1);break;case"ArrowDown":t.x==o[0].style.gridColumnStart&&t.y>o[0].style.gridRowStart-u.snakeLength&&t.y<Number(o[0].style.gridRowStart)+e&&(t.x+=1)}x(["water"],t.x,t.y,i)}function L(e){if(l)switch(e){case"ArrowRight":c=Number(o[0].style.gridColumnStart)+1==o[1].style.gridColumnStart?c:e;break;case"ArrowLeft":c=Number(o[0].style.gridColumnStart)-1==o[1].style.gridColumnStart?c:e;break;case"ArrowUp":c=Number(o[0].style.gridRowStart)-1==o[1].style.gridRowStart?c:e;break;case"ArrowDown":c=Number(o[0].style.gridRowStart)+1==o[1].style.gridRowStart?c:e}}function z(g=0){e.style.display="",setTimeout(()=>{t.style.display=r.style.display=n.style.display="none",l=setInterval(Y,1e3/m)},g),S.style.gridTemplateRows=S.style.gridTemplateColumns="repeat("+u.gameFieldSize+", 1fr)",S.style.gridGap=u.snakeView,S.innerHTML="",m=u.speed,c=u.direction,y=d=p.textContent=0,o=[],s=[],i=[],function(e,t){let r=snakePosY=Math.floor(u.gameFieldSize/2);x(["snake-block","snake-block_head"],r,snakePosY,o);for(let n=1;n<e;n++)switch(t){case"ArrowRight":x(["snake-block"],r-n,snakePosY,o);break;case"ArrowLeft":x(["snake-block"],r+n,snakePosY,o);break;case"ArrowUp":x(["snake-block"],r,snakePosY+n,o);break;case"ArrowDown":x(["snake-block"],r,snakePosY-n,o)}}(u.snakeLength,c);for(let e=0;e<u.minFruitsNumber;e++)F();for(;i.length<u.waterAreaSize;)I();a=setInterval(F,1e3*u.fruitsSpawnInterval)}function M(){clearInterval(l),clearInterval(a),l=!1,f.textContent=d,t.style.display=n.style.display="none",r.style.display=e.style.display=""}function T(){l&&(clearInterval(l),clearInterval(a),h.textContent=y,v.textContent=d,t.style.display=r.style.display=b.style.display="none",n.style.display=w.style.display=e.style.display="")}function D(e){m+e>u.speed&&(m+=e,clearInterval(l),l=setInterval(Y,1e3/m))}function Y(){!function(){for(let n=o.length-1;n>0;n--)e=o[n],t=o[n-1].style.gridColumnStart,r=o[n-1].style.gridRowStart,e.style.gridColumnStart=t,e.style.gridRowStart=r;var e,t,r;switch(c){case"ArrowRight":R(Number(o[0].style.gridColumnStart)+1,1)?o[0].style.gridColumnStart++:u.gameFieldInfinity?o[0].style.gridColumnStart=1:M();break;case"ArrowLeft":R(Number(o[0].style.gridColumnStart)-1,1)?o[0].style.gridColumnStart--:u.gameFieldInfinity?o[0].style.gridColumnStart=u.gameFieldSize:M();break;case"ArrowUp":R(1,Number(o[0].style.gridRowStart)-1)?o[0].style.gridRowStart--:u.gameFieldInfinity?o[0].style.gridRowStart=u.gameFieldSize:M();break;case"ArrowDown":R(1,Number(o[0].style.gridRowStart)+1)?o[0].style.gridRowStart++:u.gameFieldInfinity?o[0].style.gridRowStart=1:M()}}();let e=N(o[0].style.gridColumnStart,o[0].style.gridRowStart,[o],[0,1,2,3]);if(e)if(u.snakeSelfDestruct)for(let t=o.length-1;t>=e;t--){let e=1e3/m*(o.length-1-t)/8;setTimeout(()=>{o[t].classList.add("snake-block_damaged"),setTimeout(()=>{C(o,t),y&&(D(-u.speedMultiplier),p.textContent=--y)},e/1.5)},e)}else M();let t=N(o[0].style.gridColumnStart,o[0].style.gridRowStart,[s]);(t||0===t)&&(!function(e){switch(e){case"apple-yellow":y+=1;break;case"apple-red":y+=2;break;case"banana":y+=3;break;case"strawberry":y+=5;break;case"grapes":y+=10}y>d&&(d=y)}(s[t].classList[1]),D((y-p.textContent)*u.speedMultiplier),p.textContent=y,C(s,t),x(["snake-block"],o[o.length-1].style.gridColumnStart,o[o.length-1].style.gridRowStart,o),s.length<u.minFruitsNumber&&F());let r=N(o[0].style.gridColumnStart,o[0].style.gridRowStart,[i]);(r||0===r)&&(C(i,r),y+-5>-1?(C(o,o.length-1),D(-5*u.speedMultiplier),y+=-5,p.textContent=y):M())}document.addEventListener("touchstart",(function(e){g[0].x=e.changedTouches[0].pageX,g[0].y=e.changedTouches[0].pageY}),!1),document.addEventListener("touchend",(function(e){if(g[1].x=e.changedTouches[0].pageX,g[1].y=e.changedTouches[0].pageY,Math.abs(g[0].x-g[1].x)>Math.abs(g[0].y-g[1].y)&&Math.abs(g[0].x-g[1].x)>30){L(g[0].x>g[1].x?"ArrowLeft":"ArrowRight")}else if(Math.abs(g[0].y-g[1].y)>30){L(g[0].y>g[1].y?"ArrowUp":"ArrowDown")}else T()}),!1),window.onkeydown=function(e){L(e.key)};const P=t.querySelector(".game-settings-form"),U=P.querySelector("input[name=snake-start-length]"),E=P.querySelector("select[name=snake-start-direction]"),B=P.querySelector("input[name=snake-start-speed]"),V=P.querySelector("input[name=snake-speed-multiplier]"),X=P.querySelector("select[name=snake-body-view]"),G=P.querySelector("input[name=game-field-size]"),H=P.querySelector("select[name=game-field-infinity]"),W=P.querySelector("input[name=game-max-fruits]"),j=P.querySelector("input[name=game-min-fruits]"),J=P.querySelector("input[name=fruits-spawn-delay]"),K=P.querySelector("select[name=snake-self-destruct]"),O=P.querySelector("input[name=water-area-size]"),Q=document.querySelectorAll(".button_play"),Z=document.querySelectorAll(".button_menu"),$=document.querySelector(".button_continue");P.onsubmit=function(e){e.preventDefault(),u={snakeLength:Number(U.value),direction:E.value,speed:Number(B.value),speedMultiplier:Number(V.value),gameFieldSize:Number(G.value),gameFieldInfinity:Boolean(Number(H.value)),maxFruitsNumber:Number(W.value),minFruitsNumber:Number(j.value),fruitsSpawnInterval:Number(J.value),snakeView:X.value,snakeSelfDestruct:Boolean(Number(K.value)),waterAreaSize:Number(O.value)/100*Number(G.value)**2},z(400)};for(const e of Q)e.onclick=function(){z()};Q[0].onclick=()=>{this.offsetWidth};for(const s of Z)s.onclick=function(){clearInterval(l),clearInterval(a),l=!1,setTimeout(()=>{e.style.display=n.style.display=r.style.display="none"},400),t.classList.add("menu-screen_animated"),t.style.display=""};$.onclick=function(){!function(){w.style.display="none",b.style.display="";let e=0;k[e].style.display="";let s=setInterval(()=>{e++,k[e-1].style.display="none",k[e].style.display=""},1100);setTimeout(()=>{clearInterval(s),t.style.display=n.style.display=b.style.display=r.style.display="none",l=setInterval(Y,1e3/m),a=setInterval(F,1e3*u.fruitsSpawnInterval)},3300)}()},e.onclick=function(){T()},window.onkeyup=function(e){" "==e.key&&T()};