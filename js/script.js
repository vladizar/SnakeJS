const e=document.querySelector(".game-screen"),t=document.querySelector(".menu-screen"),r=document.querySelector(".death-screen"),n=r.querySelector(".button_play"),a=r.querySelector(".button_menu");let i,s,o=[],l=[],u=[],d={},c="",y=0,m=0,g=0,p=[{x:0,y:0},{x:0,y:0}];const S=e.querySelector(".game-screen__field"),w=e.querySelector(".game-screen__score"),f=r.querySelector(".death-screen__score");function b(e,t,r,n){const a=document.createElement("div");for(const t of e)a.classList.add(t);a.style.gridColumnStart=t,a.style.gridRowStart=r,n.push(a),S.append(a)}function k(e,t){S.removeChild(e[t]),e.splice(t,1)}function h(e,t){return!(e>d.gameFieldSize||t>d.gameFieldSize||e<1||t<1)}function x(e,t,r,n=[-1]){for(const a of r)for(let r=0;r<a.length;r++){const i=a[r];if(i.style.gridColumnStart==e&&i.style.gridRowStart==t){if(n[r]==r)continue;return r}}return!1}function C(e){return Math.floor(Math.random().toFixed(8)*(e+1))}function R(){return Math.random().toFixed(2)}function N(){let e={x:0,y:0};do{e={x:C(d.gameFieldSize),y:C(d.gameFieldSize)}}while(x(e.x,e.y,[o,l,u])||!h(e.x,e.y));return e}function v(){if(o.length<d.maxFruitsNumber){let e=N();fruitClass=R()<=.05?"grapes":R()<=.1?"strawberry":R()<=.2?"banana":o.length==d.minFruitsNumber-1?"apple-red":"apple-yellow",b(["fruit",fruitClass],e.x,e.y,o)}}function A(){switch(position=N(),d.direction){case"ArrowRight":position.y==l[0].style.gridRowStart&&position.x>l[0].style.gridColumnStart-d.snakeLength&&position.x<Number(l[0].style.gridColumnStart)+2*d.speed&&(position.y+=1);break;case"ArrowLeft":position.y==l[0].style.gridRowStart&&position.x<l[0].style.gridColumnStart-d.snakeLength&&position.x>Number(l[0].style.gridColumnStart)-2*d.speed&&(position.y+=1);break;case"ArrowUp":position.x==l[0].style.gridColumnStart&&position.y<l[0].style.gridRowStart-d.snakeLength&&position.y>Number(l[0].style.gridRowStart)-2*d.speed&&(position.x+=1);break;case"ArrowDown":position.x==l[0].style.gridColumnStart&&position.y>l[0].style.gridRowStart-d.snakeLength&&position.y<Number(l[0].style.gridRowStart)+2*d.speed&&(position.x+=1)}b(["water"],position.x,position.y,u)}function F(e){switch(e){case"ArrowRight":c=Number(l[0].style.gridColumnStart)+1==l[1].style.gridColumnStart?c:e;break;case"ArrowLeft":c=Number(l[0].style.gridColumnStart)-1==l[1].style.gridColumnStart?c:e;break;case"ArrowUp":c=Number(l[0].style.gridRowStart)-1==l[1].style.gridRowStart?c:e;break;case"ArrowDown":c=Number(l[0].style.gridRowStart)+1==l[1].style.gridRowStart?c:e}}function q(n=0){e.style.display="",setTimeout(()=>{t.style.display=r.style.display="none",i=setInterval(I,1e3/g)},n),S.style.gridTemplateRows=S.style.gridTemplateColumns="repeat("+d.gameFieldSize+", 1fr)",S.style.gridGap=d.snakeView,S.innerHTML="",g=d.speed,c=d.direction,y=m=w.textContent=0,l=[],o=[],u=[],function(e,t){let r=snakePosY=Math.floor(d.gameFieldSize/2);b(["snake-block","snake-block_head"],r,snakePosY,l);for(let n=1;n<e;n++)switch(t){case"ArrowRight":b(["snake-block"],r-n,snakePosY,l);break;case"ArrowLeft":b(["snake-block"],r+n,snakePosY,l);break;case"ArrowUp":b(["snake-block"],r,snakePosY+n,l);break;case"ArrowDown":b(["snake-block"],r,snakePosY-n,l)}}(d.snakeLength,c);for(let e=0;e<d.minFruitsNumber;e++)v();for(;u.length<d.waterAreaSize;)A();s=setInterval(v,1e3*d.fruitsSpawnInterval)}function L(){clearInterval(i),clearInterval(s),f.textContent=m,t.style.display="none",r.style.display=e.style.display=""}function z(e){g+e>d.speed&&(g+=e,clearInterval(i),i=setInterval(I,1e3/g))}function I(){!function(){for(let n=l.length-1;n>0;n--)e=l[n],t=l[n-1].style.gridColumnStart,r=l[n-1].style.gridRowStart,e.style.gridColumnStart=t,e.style.gridRowStart=r;var e,t,r;switch(c){case"ArrowRight":h(Number(l[0].style.gridColumnStart)+1,1)?l[0].style.gridColumnStart++:d.gameFieldInfinity?l[0].style.gridColumnStart=1:L();break;case"ArrowLeft":h(Number(l[0].style.gridColumnStart)-1,1)?l[0].style.gridColumnStart--:d.gameFieldInfinity?l[0].style.gridColumnStart=d.gameFieldSize:L();break;case"ArrowUp":h(1,Number(l[0].style.gridRowStart)-1)?l[0].style.gridRowStart--:d.gameFieldInfinity?l[0].style.gridRowStart=d.gameFieldSize:L();break;case"ArrowDown":h(1,Number(l[0].style.gridRowStart)+1)?l[0].style.gridRowStart++:d.gameFieldInfinity?l[0].style.gridRowStart=1:L()}}();let e=x(l[0].style.gridColumnStart,l[0].style.gridRowStart,[l],[0,1,2,3]);if(e)if(d.snakeSelfDestruct)for(let t=l.length-1;t>=e;t--){let e=1e3/g*(l.length-1-t)/8;setTimeout(()=>{l[t].classList.add("snake-block_damaged"),setTimeout(()=>{k(l,t),y&&(z(-d.speedMultiplier),w.textContent=--y)},e/1.5)},e)}else L();let t=x(l[0].style.gridColumnStart,l[0].style.gridRowStart,[o]);(t||0===t)&&(!function(e){switch(e){case"apple-yellow":y++;break;case"apple-red":y+=2;break;case"banana":y+=3;break;case"strawberry":y+=5;break;case"grapes":y+=10}y>m&&(m=y)}(o[t].classList[1]),z((y-w.textContent)*d.speedMultiplier),w.textContent=y,k(o,t),b(["snake-block"],l[l.length-1].style.gridColumnStart,l[l.length-1].style.gridRowStart,l),o.length<d.minFruitsNumber&&v());let r=x(l[0].style.gridColumnStart,l[0].style.gridRowStart,[u]);r&&(k(u,r),y-5>-1?(k(l,l.length-1),z(5*-d.speedMultiplier),y-=5,w.textContent=y):L())}document.addEventListener("touchstart",(function(e){p[0].x=e.changedTouches[0].pageX,p[0].y=e.changedTouches[0].pageY}),!1),document.addEventListener("touchend",(function(e){if(p[1].x=e.changedTouches[0].pageX,p[1].y=e.changedTouches[0].pageY,Math.abs(p[0].x-p[1].x)>Math.abs(p[0].y-p[1].y)&&Math.abs(p[0].x-p[1].x)>30){F(p[0].x>p[1].x?"ArrowLeft":"ArrowRight")}else if(Math.abs(p[0].y-p[1].y)>30){F(p[0].y>p[1].y?"ArrowUp":"ArrowDown")}}),!1),window.onkeydown=function(e){F(e.key)};const M=t.querySelector(".game-settings-form"),T=M.querySelector("input[name=snake-start-length]"),_=M.querySelector("select[name=snake-start-direction]"),D=M.querySelector("input[name=snake-start-speed]"),Y=M.querySelector("input[name=snake-speed-multiplier]"),P=M.querySelector("select[name=snake-body-view]"),U=M.querySelector("input[name=game-field-size]"),E=M.querySelector("select[name=game-field-infinity]"),B=M.querySelector("input[name=game-max-fruits]"),V=M.querySelector("input[name=game-min-fruits]"),X=M.querySelector("input[name=fruits-spawn-delay]"),G=M.querySelector("select[name=snake-self-destruct]"),H=M.querySelector("input[name=water-area-size]");M.onsubmit=function(e){e.preventDefault(),d={snakeLength:Number(T.value),direction:_.value,speed:Number(D.value),speedMultiplier:Number(Y.value),gameFieldSize:Number(U.value),gameFieldInfinity:Boolean(Number(E.value)),maxFruitsNumber:Number(B.value),minFruitsNumber:Number(V.value),fruitsSpawnInterval:Number(X.value),snakeView:P.value,snakeSelfDestruct:Boolean(Number(G.value)),waterAreaSize:Number(H.value)/100*Number(U.value)**2},q(400)},a.onclick=function(){setTimeout(()=>{e.style.display=r.style.display="none"},400),t.classList.add("menu-screen_animated"),t.style.display=""},n.onclick=function(){q()};